
{% extends "layouts/base.html" %}
{% block title %}الذكاء الاصطناعي المتقدم{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-body">
                    <h1 class="display-4 text-center mb-4">
                        <i data-feather="cpu" class="me-3"></i>
                        الذكاء الاصطناعي المتقدم
                    </h1>
                    <p class="lead text-center text-muted">
                        تحليل ذكي متطور للمواقع باستخدام خوارزميات الذكاء الاصطناعي
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Input -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="search" class="me-2"></i>
                        بدء التحليل الذكي
                    </h3>
                </div>
                <div class="card-body">
                    <form id="aiAnalysisForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="websiteUrl" class="form-label">رابط الموقع</label>
                                    <input type="url" class="form-control" id="websiteUrl" 
                                           placeholder="https://example.com" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i data-feather="play" class="me-2"></i>
                                        بدء التحليل
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analysis Options -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>خيارات التحليل</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="semanticAnalysis" checked>
                                            <label class="form-check-label" for="semanticAnalysis">
                                                التحليل الدلالي
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="businessLogic" checked>
                                            <label class="form-check-label" for="businessLogic">
                                                منطق الأعمال
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="uxPatterns" checked>
                                            <label class="form-check-label" for="uxPatterns">
                                                أنماط UX
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="optimizations" checked>
                                            <label class="form-check-label" for="optimizations">
                                                التوصيات
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Monitor -->
    <div class="row mb-4" id="progressSection" style="display: none;">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-body">
                    <h5>جاري التحليل...</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="analysisProgress" style="width: 0%"></div>
                    </div>
                    <div id="currentTask">جاري التحضير للتحليل...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row" id="resultsSection" style="display: none;">
        <!-- Semantic Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="layers" class="me-2"></i>
                        التحليل الدلالي
                    </h4>
                </div>
                <div class="card-body">
                    <div id="semanticResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Business Logic -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="briefcase" class="me-2"></i>
                        منطق الأعمال
                    </h4>
                </div>
                <div class="card-body">
                    <div id="businessLogicResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- UX Patterns -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="users" class="me-2"></i>
                        أنماط تجربة المستخدم
                    </h4>
                </div>
                <div class="card-body">
                    <div id="uxPatternsResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Architecture Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="box" class="me-2"></i>
                        تحليل البنية التقنية
                    </h4>
                </div>
                <div class="card-body">
                    <div id="architectureResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Strategy -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="file-text" class="me-2"></i>
                        استراتيجية المحتوى
                    </h4>
                </div>
                <div class="card-body">
                    <div id="contentStrategyResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization Recommendations -->
        <div class="col-md-6 mb-4">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h4 class="card-title">
                        <i data-feather="trending-up" class="me-2"></i>
                        توصيات التحسين
                    </h4>
                </div>
                <div class="card-body">
                    <div id="optimizationResults">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4" id="actionButtons" style="display: none;">
        <div class="col-12 text-center">
            <button class="btn btn-success me-3" id="downloadReport">
                <i data-feather="download" class="me-2"></i>
                تحميل التقرير
            </button>
            <button class="btn btn-primary me-3" id="generateSite">
                <i data-feather="copy" class="me-2"></i>
                إنشاء موقع مطابق
            </button>
            <button class="btn btn-secondary" id="saveAnalysis">
                <i data-feather="save" class="me-2"></i>
                حفظ التحليل
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('aiAnalysisForm');
    const progressSection = document.getElementById('progressSection');
    const resultsSection = document.getElementById('resultsSection');
    const actionButtons = document.getElementById('actionButtons');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const url = document.getElementById('websiteUrl').value;
        const options = {
            semantic_analysis: document.getElementById('semanticAnalysis').checked,
            business_logic: document.getElementById('businessLogic').checked,
            ux_patterns: document.getElementById('uxPatterns').checked,
            optimizations: document.getElementById('optimizations').checked
        };

        // Show progress
        progressSection.style.display = 'block';
        resultsSection.style.display = 'none';
        actionButtons.style.display = 'none';

        try {
            // Start deep extraction first
            updateProgress(20, 'بدء الاستخراج العميق...');
            const extractionResponse = await fetch('/api/deep-extraction/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            });

            if (!extractionResponse.ok) throw new Error('Extraction failed');
            
            const extractionData = await extractionResponse.json();
            
            updateProgress(60, 'تشغيل تحليل الذكاء الاصطناعي...');
            
            // Run AI analysis
            const aiResponse = await fetch('/api/advanced-ai/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    url: url,
                    extraction_data: extractionData.results || {}
                })
            });

            if (!aiResponse.ok) throw new Error('AI analysis failed');
            
            const aiResults = await aiResponse.json();
            
            updateProgress(100, 'اكتمل التحليل!');
            
            // Display results
            displayResults(aiResults.ai_analysis);
            
            // Show action buttons
            actionButtons.style.display = 'block';
            
            setTimeout(() => {
                progressSection.style.display = 'none';
            }, 1000);

        } catch (error) {
            console.error('Analysis error:', error);
            updateProgress(0, 'حدث خطأ في التحليل: ' + error.message);
        }
    });

    function updateProgress(percentage, task) {
        document.getElementById('analysisProgress').style.width = percentage + '%';
        document.getElementById('currentTask').textContent = task;
    }

    function displayResults(analysis) {
        resultsSection.style.display = 'block';
        
        // Semantic Analysis
        if (analysis.semantic_understanding) {
            displaySemanticResults(analysis.semantic_understanding);
        }
        
        // Business Logic
        if (analysis.business_logic_detection) {
            displayBusinessLogicResults(analysis.business_logic_detection);
        }
        
        // UX Patterns
        if (analysis.user_experience_patterns) {
            displayUXPatternsResults(analysis.user_experience_patterns);
        }
        
        // Architecture
        if (analysis.technical_architecture) {
            displayArchitectureResults(analysis.technical_architecture);
        }
        
        // Content Strategy
        if (analysis.content_strategy) {
            displayContentStrategyResults(analysis.content_strategy);
        }
        
        // Optimizations
        if (analysis.optimization_recommendations) {
            displayOptimizationResults(analysis.optimization_recommendations);
        }
    }

    function displaySemanticResults(semantic) {
        const container = document.getElementById('semanticResults');
        let html = '<div class="semantic-analysis">';
        
        if (semantic.content_hierarchy) {
            html += '<h6>التسلسل الهرمي للمحتوى</h6>';
            html += '<ul class="list-group list-group-flush mb-3">';
            semantic.content_hierarchy.forEach(item => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>H${item.level}: ${item.text}</span>
                    <span class="badge bg-primary rounded-pill">${(item.importance * 100).toFixed(0)}%</span>
                </li>`;
            });
            html += '</ul>';
        }
        
        if (semantic.navigation_patterns) {
            html += '<h6>أنماط التنقل</h6>';
            html += '<div class="nav-patterns">';
            Object.keys(semantic.navigation_patterns).forEach(key => {
                if (semantic.navigation_patterns[key].length > 0) {
                    html += `<p><strong>${key}:</strong> ${semantic.navigation_patterns[key].length} عنصر</p>`;
                }
            });
            html += '</div>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayBusinessLogicResults(businessLogic) {
        const container = document.getElementById('businessLogicResults');
        let html = '<div class="business-logic">';
        
        if (businessLogic.core_functions) {
            html += '<h6>الوظائف الأساسية</h6>';
            html += '<ul class="list-group list-group-flush mb-3">';
            businessLogic.core_functions.forEach(func => {
                html += `<li class="list-group-item">
                    <strong>${func.type}:</strong> ${func.function || func.name}
                    <small class="text-muted d-block">${func.purpose}</small>
                </li>`;
            });
            html += '</ul>';
        }
        
        if (businessLogic.user_workflows) {
            html += '<h6>سير عمل المستخدم</h6>';
            html += `<p class="text-muted">${businessLogic.user_workflows.length} مسار عمل مكتشف</p>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayUXPatternsResults(uxPatterns) {
        const container = document.getElementById('uxPatternsResults');
        let html = '<div class="ux-patterns">';
        
        if (uxPatterns.interaction_patterns) {
            html += '<h6>أنماط التفاعل</h6>';
            html += `<p>${uxPatterns.interaction_patterns.length} نمط تفاعل مكتشف</p>`;
        }
        
        if (uxPatterns.visual_hierarchy) {
            html += '<h6>التسلسل الهرمي المرئي</h6>';
            html += '<ul class="list-unstyled">';
            Object.keys(uxPatterns.visual_hierarchy).forEach(key => {
                html += `<li><strong>${key}:</strong> ${uxPatterns.visual_hierarchy[key].length} عنصر</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayArchitectureResults(architecture) {
        const container = document.getElementById('architectureResults');
        let html = '<div class="architecture">';
        
        if (architecture.frontend_architecture) {
            html += '<h6>البنية الأمامية</h6>';
            const frontend = architecture.frontend_architecture;
            if (frontend.frameworks && frontend.frameworks.length > 0) {
                html += `<p><strong>الإطارات:</strong> ${frontend.frameworks.join(', ')}</p>`;
            }
            if (frontend.libraries && frontend.libraries.length > 0) {
                html += `<p><strong>المكتبات:</strong> ${frontend.libraries.join(', ')}</p>`;
            }
        }
        
        if (architecture.backend_architecture) {
            html += '<h6>البنية الخلفية</h6>';
            const backend = architecture.backend_architecture;
            if (backend.server_technology) {
                html += `<p><strong>تقنية الخادم:</strong> ${backend.server_technology}</p>`;
            }
            if (backend.database_technology) {
                html += `<p><strong>قاعدة البيانات:</strong> ${backend.database_technology}</p>`;
            }
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayContentStrategyResults(contentStrategy) {
        const container = document.getElementById('contentStrategyResults');
        let html = '<div class="content-strategy">';
        
        if (contentStrategy.content_types) {
            html += '<h6>أنواع المحتوى</h6>';
            html += '<ul class="list-group list-group-flush mb-3">';
            contentStrategy.content_types.forEach(type => {
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>${type.type}</span>
                    <span class="badge bg-secondary">${type.count}</span>
                </li>`;
            });
            html += '</ul>';
        }
        
        if (contentStrategy.seo_strategy) {
            html += '<h6>استراتيجية SEO</h6>';
            html += '<p class="text-muted">تم تحليل العوامل التقنية والمحتوى</p>';
        }
        
        html += '</div>';
        container.innerHTML = html;
    }

    function displayOptimizationResults(optimizations) {
        const container = document.getElementById('optimizationResults');
        let html = '<div class="optimizations">';
        
        Object.keys(optimizations).forEach(category => {
            if (optimizations[category] && optimizations[category].length > 0) {
                html += `<h6>${category}</h6>`;
                html += '<ul class="list-group list-group-flush mb-3">';
                optimizations[category].forEach(suggestion => {
                    html += `<li class="list-group-item">
                        <i data-feather="check-circle" class="me-2 text-success"></i>
                        ${suggestion}
                    </li>`;
                });
                html += '</ul>';
            }
        });
        
        html += '</div>';
        container.innerHTML = html;
        
        // Re-initialize Feather icons
        feather.replace();
    }
});
</script>
{% endblock %}
