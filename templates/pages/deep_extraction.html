{% extends "layouts/base.html" %}

{% block title %}محرك الاستخراج العميق{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- عنوان الصفحة -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-body text-center py-5">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <i data-feather="layers" class="me-3" style="width: 48px; height: 48px; color: var(--primary-color);"></i>
                        <h1 class="display-5 fw-bold gradient-text mb-0">محرك الاستخراج العميق</h1>
                    </div>
                    <p class="lead text-muted">استخراج شامل للمواقع مع تحليل متقدم وإعادة إنشاء ذكية</p>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الاستخراج -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0 pb-0">
                    <h3 class="card-title">
                        <i data-feather="download" class="me-2"></i>
                        بدء الاستخراج العميق
                    </h3>
                </div>
                <div class="card-body">
                    <form id="deepExtractionForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="targetUrl" class="form-label fw-bold">رابط الموقع المستهدف</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0">
                                            <i data-feather="link" style="width: 18px; height: 18px;"></i>
                                        </span>
                                        <input type="url" class="form-control border-start-0" id="targetUrl" 
                                               placeholder="https://example.com" required>
                                    </div>
                                    <div class="form-text">أدخل رابط الموقع الذي تريد استخراجه وتحليله بشكل شامل</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="extractionMode" class="form-label fw-bold">وضع الاستخراج</label>
                                    <select class="form-select" id="extractionMode">
                                        <option value="basic">أساسي - سريع</option>
                                        <option value="standard">معياري - متوازن</option>
                                        <option value="advanced">متقدم - شامل</option>
                                        <option value="comprehensive" selected>شامل - كامل</option>
                                        <option value="ultra">فائق - بذكاء اصطناعي</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- إعدادات متقدمة -->
                        <div class="row">
                            <div class="col-12">
                                <div class="accordion mb-3" id="advancedSettings">
                                    <div class="accordion-item glass-card border-0">
                                        <h2 class="accordion-header" id="settingsHeader">
                                            <button class="accordion-button collapsed bg-transparent border-0" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#settingsCollapse">
                                                <i data-feather="settings" class="me-2"></i>
                                                إعدادات متقدمة
                                            </button>
                                        </h2>
                                        <div id="settingsCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedSettings">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">عمق الاستخراج</label>
                                                            <input type="range" class="form-range" id="maxDepth" min="1" max="10" value="3">
                                                            <div class="d-flex justify-content-between">
                                                                <span class="text-muted">1</span>
                                                                <span id="depthValue">3</span>
                                                                <span class="text-muted">10</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">حد الصفحات</label>
                                                            <input type="number" class="form-control" id="maxPages" value="50" min="10" max="500">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">التأخير (ثانية)</label>
                                                            <input type="number" class="form-control" id="delayBetweenRequests" 
                                                                   value="1.0" step="0.1" min="0.1" max="5.0">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- خيارات الاستخراج -->
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6 class="fw-bold mb-3">مكونات الاستخراج</h6>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeAssets" checked>
                                                            <label class="form-check-label" for="includeAssets">
                                                                استخراج الملفات والأصول
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeJavaScript" checked>
                                                            <label class="form-check-label" for="includeJavaScript">
                                                                تحليل JavaScript
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeCSS" checked>
                                                            <label class="form-check-label" for="includeCSS">
                                                                تحليل CSS والتصميم
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="fw-bold mb-3">تحليل متقدم</h6>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="extractAPIs" checked>
                                                            <label class="form-check-label" for="extractAPIs">
                                                                اكتشاف API endpoints
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="analyzeBehavior" checked>
                                                            <label class="form-check-label" for="analyzeBehavior">
                                                                تحليل سلوك الموقع
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="extractDatabase">
                                                            <label class="form-check-label" for="extractDatabase">
                                                                استخراج مخطط قاعدة البيانات
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- محركات الاستخراج -->
                                                <div class="row mt-3">
                                                    <div class="col-12">
                                                        <h6 class="fw-bold mb-3">محركات الاستخراج</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="form-check mb-2">
                                                                    <input class="form-check-input" type="checkbox" id="enablePlaywright" checked>
                                                                    <label class="form-check-label" for="enablePlaywright">
                                                                        Playwright (للمواقع التفاعلية)
                                                                    </label>
                                                                </div>
                                                                <div class="form-check mb-2">
                                                                    <input class="form-check-input" type="checkbox" id="enableSelenium" checked>
                                                                    <label class="form-check-label" for="enableSelenium">
                                                                        Selenium (للمواقع المعقدة)
                                                                    </label>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-check mb-2">
                                                                    <input class="form-check-input" type="checkbox" id="respectRobots" checked>
                                                                    <label class="form-check-label" for="respectRobots">
                                                                        احترام robots.txt
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التحكم -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-3">
                                    <button type="submit" class="btn btn-primary btn-lg px-4" id="startExtractionBtn">
                                        <i data-feather="play" class="me-2"></i>
                                        بدء الاستخراج العميق
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="clearFormBtn">
                                        <i data-feather="refresh-cw" class="me-2"></i>
                                        إعادة تعيين
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- مراقب التقدم -->
    <div class="row mb-4" id="progressSection" style="display: none;">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="activity" class="me-2"></i>
                        حالة الاستخراج
                    </h3>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressText">جاري الاستخراج...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="pagesProcessed">0</h4>
                                <p class="text-muted">صفحات معالجة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="assetsExtracted">0</h4>
                                <p class="text-muted">ملفات مستخرجة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="apisDiscovered">0</h4>
                                <p class="text-muted">APIs مكتشفة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="elapsedTime">00:00</h4>
                                <p class="text-muted">وقت الاستخراج</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-danger" id="cancelExtractionBtn">
                            <i data-feather="x" class="me-2"></i>
                            إلغاء الاستخراج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- النتائج -->
    <div class="row" id="resultsSection" style="display: none;">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="check-circle" class="me-2"></i>
                        نتائج الاستخراج العميق
                    </h3>
                </div>
                <div class="card-body">
                    <div id="resultsContent">
                        <!-- سيتم ملء النتائج هنا بواسطة JavaScript -->
                    </div>
                    
                    <div class="mt-4 d-flex gap-3">
                        <button type="button" class="btn btn-success" id="replicateBtn">
                            <i data-feather="copy" class="me-2"></i>
                            إنشاء موقع مطابق
                        </button>
                        <button type="button" class="btn btn-info" id="analyzeAIBtn">
                            <i data-feather="brain" class="me-2"></i>
                            تحليل بالذكاء الاصطناعي
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="downloadResultsBtn">
                            <i data-feather="download" class="me-2"></i>
                            تحميل النتائج
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    padding: 1rem;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-card h4 {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--primary-color);
}

.progress {
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
}

.progress-bar {
    border-radius: 10px;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
}

.form-range {
    accent-color: var(--primary-color);
}
</style>

<script>
class DeepExtractionManager {
    constructor() {
        this.currentExtractionId = null;
        this.progressTimer = null;
        this.startTime = null;
        this.initEventListeners();
    }

    initEventListeners() {
        document.getElementById('deepExtractionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.startExtraction();
        });

        document.getElementById('clearFormBtn').addEventListener('click', () => {
            this.clearForm();
        });

        document.getElementById('cancelExtractionBtn').addEventListener('click', () => {
            this.cancelExtraction();
        });

        document.getElementById('replicateBtn').addEventListener('click', () => {
            this.replicateWebsite();
        });

        document.getElementById('analyzeAIBtn').addEventListener('click', () => {
            this.analyzeWithAI();
        });

        document.getElementById('downloadResultsBtn').addEventListener('click', () => {
            this.downloadResults();
        });

        // تحديث قيمة عمق الاستخراج
        document.getElementById('maxDepth').addEventListener('input', (e) => {
            document.getElementById('depthValue').textContent = e.target.value;
        });
    }

    async startExtraction() {
        const formData = this.collectFormData();
        
        try {
            const response = await fetch('/api/deep-extraction/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();
            
            if (response.ok) {
                this.currentExtractionId = result.extraction_id;
                this.showProgressSection();
                this.startProgressMonitoring();
            } else {
                alert('خطأ في بدء الاستخراج: ' + result.error);
            }
        } catch (error) {
            alert('خطأ في الاتصال: ' + error.message);
        }
    }

    collectFormData() {
        return {
            url: document.getElementById('targetUrl').value,
            config: {
                mode: document.getElementById('extractionMode').value,
                max_depth: parseInt(document.getElementById('maxDepth').value),
                max_pages: parseInt(document.getElementById('maxPages').value),
                delay_between_requests: parseFloat(document.getElementById('delayBetweenRequests').value),
                include_assets: document.getElementById('includeAssets').checked,
                include_javascript: document.getElementById('includeJavaScript').checked,
                include_css: document.getElementById('includeCSS').checked,
                extract_apis: document.getElementById('extractAPIs').checked,
                analyze_behavior: document.getElementById('analyzeBehavior').checked,
                extract_database_schema: document.getElementById('extractDatabase').checked,
                enable_playwright: document.getElementById('enablePlaywright').checked,
                enable_selenium: document.getElementById('enableSelenium').checked,
                respect_robots_txt: document.getElementById('respectRobots').checked
            }
        };
    }

    showProgressSection() {
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        this.startTime = Date.now();
    }

    startProgressMonitoring() {
        this.progressTimer = setInterval(() => {
            this.checkExtractionStatus();
            this.updateElapsedTime();
        }, 2000);
    }

    async checkExtractionStatus() {
        if (!this.currentExtractionId) return;

        try {
            const response = await fetch(`/api/deep-extraction/status/${this.currentExtractionId}`);
            const result = await response.json();

            if (result.status === 'completed') {
                this.handleExtractionComplete();
            } else if (result.status === 'failed') {
                this.handleExtractionFailed(result.error);
            }
        } catch (error) {
            console.error('خطأ في مراقبة التقدم:', error);
        }
    }

    updateElapsedTime() {
        if (!this.startTime) return;
        
        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('elapsedTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async handleExtractionComplete() {
        clearInterval(this.progressTimer);
        
        try {
            const response = await fetch(`/api/deep-extraction/result/${this.currentExtractionId}`);
            const result = await response.json();
            
            this.displayResults(result);
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
        } catch (error) {
            alert('خطأ في جلب النتائج: ' + error.message);
        }
    }

    handleExtractionFailed(error) {
        clearInterval(this.progressTimer);
        alert('فشل الاستخراج: ' + error);
        document.getElementById('progressSection').style.display = 'none';
    }

    displayResults(result) {
        const content = document.getElementById('resultsContent');
        const extractionResult = result.result;
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h5>معلومات الاستخراج</h5>
                    <ul class="list-unstyled">
                        <li><strong>الموقع:</strong> ${extractionResult.metadata.target_url}</li>
                        <li><strong>وقت الاستخراج:</strong> ${extractionResult.metadata.extraction_time.toFixed(2)} ثانية</li>
                        <li><strong>معرف الاستخراج:</strong> ${extractionResult.metadata.extraction_id}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h5>إحصائيات الاستخراج</h5>
                    <ul class="list-unstyled">
                        <li><strong>URLs مزارة:</strong> ${extractionResult.extraction_statistics.total_urls_visited}</li>
                        <li><strong>APIs مكتشفة:</strong> ${extractionResult.extraction_statistics.api_endpoints_discovered}</li>
                        <li><strong>أحداث JavaScript:</strong> ${extractionResult.extraction_statistics.javascript_events_found}</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-4">
                <h5>مراحل الاستخراج المكتملة</h5>
                <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        تحليل البنية الأولية
                        <span class="badge bg-success rounded-pill">مكتمل</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        استخراج الواجهة الكاملة
                        <span class="badge bg-success rounded-pill">مكتمل</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        استخراج البنية التقنية
                        <span class="badge bg-success rounded-pill">مكتمل</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        استخراج الوظائف والميزات
                        <span class="badge bg-success rounded-pill">مكتمل</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        تحليل سلوك الموقع
                        <span class="badge bg-success rounded-pill">مكتمل</span>
                    </div>
                </div>
            </div>
        `;
    }

    async cancelExtraction() {
        if (!this.currentExtractionId) return;

        try {
            const response = await fetch(`/api/deep-extraction/cancel/${this.currentExtractionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                clearInterval(this.progressTimer);
                document.getElementById('progressSection').style.display = 'none';
                alert('تم إلغاء الاستخراج');
            }
        } catch (error) {
            alert('خطأ في إلغاء الاستخراج: ' + error.message);
        }
    }

    async replicateWebsite() {
        if (!this.currentExtractionId) return;

        try {
            const response = await fetch('/api/deep-extraction/replicate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    extraction_id: this.currentExtractionId,
                    config: {
                        framework: 'flask',
                        css_framework: 'bootstrap',
                        include_backend: true,
                        include_database: true
                    }
                })
            });

            const result = await response.json();
            
            if (response.ok) {
                alert('تم إنشاء الموقع المطابق بنجاح!');
            } else {
                alert('خطأ في إنشاء الموقع: ' + result.error);
            }
        } catch (error) {
            alert('خطأ في النسخ المتماثل: ' + error.message);
        }
    }

    async analyzeWithAI() {
        if (!this.currentExtractionId) return;

        try {
            const response = await fetch('/api/deep-extraction/analyze-with-ai', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    extraction_id: this.currentExtractionId,
                    config: {
                        analysis_depth: 'comprehensive',
                        enable_learning: true
                    }
                })
            });

            const result = await response.json();
            
            if (response.ok) {
                alert('تم التحليل بالذكاء الاصطناعي بنجاح!');
                console.log('نتائج التحليل:', result.analysis_result);
            } else {
                alert('خطأ في التحليل: ' + result.error);
            }
        } catch (error) {
            alert('خطأ في التحليل بالذكاء الاصطناعي: ' + error.message);
        }
    }

    downloadResults() {
        if (!this.currentExtractionId) {
            alert('لا توجد نتائج للتحميل');
            return;
        }

        const link = document.createElement('a');
        link.href = `/api/deep-extraction/result/${this.currentExtractionId}`;
        link.download = `extraction_${this.currentExtractionId}.json`;
        link.click();
    }

    clearForm() {
        document.getElementById('deepExtractionForm').reset();
        document.getElementById('depthValue').textContent = '3';
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        this.currentExtractionId = null;
    }
}

// تهيئة المدير عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    new DeepExtractionManager();
});
</script>
{% endblock %}