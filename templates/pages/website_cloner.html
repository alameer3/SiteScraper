{% extends "layouts/base.html" %}

{% block title %}ุฃุฏุงุฉ ูุณุฎ ุงูููุงูุน ุงููุชูุฏูุฉ{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-dark text-white border-0 shadow-lg">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h1 class="h2 mb-2">๐ ุฃุฏุงุฉ ูุณุฎ ุงูููุงูุน ุงููุชูุฏูุฉ</h1>
                            <p class="mb-0 opacity-8">ุงุณุชูุณุงุฎ ุดุงูู ููููุงูุน ูุน ุชุญููู ุฐูู ูุชูุงุฑูุฑ ููุตูุฉ</p>
                        </div>
                        <div class="text-end">
                            <div class="d-flex gap-2">
                                <a href="/website-cloner/integrated" class="btn btn-info btn-sm">
                                    <i data-feather="layers"></i> ุงููุณุฎุฉ ุงููุชูุงููุฉ
                                </a>
                                <a href="/website-cloner/comparison" class="btn btn-warning btn-sm">
                                    <i data-feather="bar-chart-2"></i> ููุงุฑูุฉ ุงูุฃุฏูุงุช
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Configuration Panel -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i data-feather="settings"></i> ุฅุนุฏุงุฏุงุช ุงูุงุณุชุฎุฑุงุฌ</h5>
                </div>
                <div class="card-body">
                    <form id="clonerForm">
                        <!-- URL Input -->
                        <div class="mb-3">
                            <label for="targetUrl" class="form-label">ุฑุงุจุท ุงููููุน ุงููุณุชูุฏู</label>
                            <input type="url" class="form-control" id="targetUrl" name="target_url" 
                                   placeholder="https://example.com" required>
                            <div class="form-text">ุฃุฏุฎู ุงูุฑุงุจุท ุงููุงูู ูููููุน ุงููุฑุงุฏ ูุณุฎู</div>
                        </div>

                        <!-- Extraction Mode -->
                        <div class="mb-3">
                            <label for="primaryTool" class="form-label">ููุน ุงูุงุณุชุฎุฑุงุฌ</label>
                            <select class="form-select" id="primaryTool" name="primary_tool">
                                <option value="website_cloner_pro">Website Cloner Pro (ุงูุฃุญุฏุซ)</option>
                                <option value="hybrid">ูุธุงู ูุฌูู (Website Cloner + ุงูุฃุฏูุงุช ุงูุญุงููุฉ)</option>
                                <option value="unified_master">ุงูุฃุฏูุงุช ุงูุญุงููุฉ ููุท</option>
                            </select>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="mb-3">
                            <label for="maxDepth" class="form-label">ุนูู ุงูุงุณุชุฎุฑุงุฌ</label>
                            <select class="form-select" id="maxDepth" name="max_depth">
                                <option value="1">ุณุทุญู (ุตูุญุฉ ูุงุญุฏุฉ)</option>
                                <option value="2">ูุชูุณุท (ูุณุชููุงู)</option>
                                <option value="3" selected>ุนููู (3 ูุณุชููุงุช)</option>
                                <option value="4">ุดุงูู (4 ูุณุชููุงุช)</option>
                                <option value="5">ูุงูู (5 ูุณุชููุงุช)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="maxPages" class="form-label">ุนุฏุฏ ุงูุตูุญุงุช ุงููุตูู</label>
                            <input type="number" class="form-control" id="maxPages" name="max_pages" 
                                   value="50" min="1" max="500">
                        </div>

                        <!-- Feature Toggles -->
                        <div class="mb-3">
                            <h6>ุงูููุฒุงุช ุงููุชูุฏูุฉ</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="extractAssets" 
                                       name="extract_assets" checked>
                                <label class="form-check-label" for="extractAssets">
                                    ุชุญููู ุงูุฃุตูู (ุตูุฑุ CSSุ JS)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="analyzeAI" 
                                       name="analyze_with_ai" checked>
                                <label class="form-check-label" for="analyzeAI">
                                    ุงูุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateReports" 
                                       name="generate_reports" checked>
                                <label class="form-check-label" for="generateReports">
                                    ุฅูุดุงุก ุงูุชูุงุฑูุฑ ุงูููุตูุฉ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useHybrid" 
                                       name="use_hybrid">
                                <label class="form-check-label" for="useHybrid">
                                    ุงุณุชุฎุฏุงู ุงูุฃุฏูุงุช ุงููุชุฎุตุตุฉ ุฅุถุงููุงู
                                </label>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn btn-primary w-100" id="startExtraction">
                            <i data-feather="play"></i> ุจุฏุก ุนูููุฉ ุงููุณุฎ
                        </button>
                    </form>
                </div>
            </div>

            <!-- Tool Information -->
            <div class="card shadow-sm border-0 mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i data-feather="info"></i> ูุนูููุงุช ุงูุฃุฏูุงุช</h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="toolsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#clonerInfo">
                                    Website Cloner Pro
                                </button>
                            </h2>
                            <div id="clonerInfo" class="accordion-collapse collapse" 
                                 data-bs-parent="#toolsAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled">
                                        <li>โ ุงุณุชุฎุฑุงุฌ ุดุงูู (6 ูุฑุงุญู)</li>
                                        <li>โ ุชุญููู ุฐูู ุจุงูAI</li>
                                        <li>โ ุชูุงุฑูุฑ ูุชุนุฏุฏุฉ ุงูุตูุบ</li>
                                        <li>โ ูุณุฎ ุทุจู ุงูุฃุตู</li>
                                        <li>โ ุชุญููู ุฃููู ูุชูุฏู</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#hybridInfo">
                                ุงููุธุงู ุงููุฌูู
                            </button>
                            <div id="hybridInfo" class="accordion-collapse collapse" 
                                 data-bs-parent="#toolsAccordion">
                                <div class="accordion-body">
                                    <ul class="list-unstyled">
                                        <li>๐ ูุฌูุน ุจูู ุฌููุน ุงูุฃุฏูุงุช</li>
                                        <li>๐ ููุงุฑูุฉ ุงููุชุงุฆุฌ</li>
                                        <li>๐ฏ ุฃูุถู ุฏูุฉ</li>
                                        <li>โก ุฃุทูู ูู ุงูููุช</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-lg-8">
            <!-- Status Card -->
            <div class="card shadow-sm border-0 mb-4" id="statusCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="activity"></i> ุญุงูุฉ ุงูุงุณุชุฎุฑุงุฌ</h5>
                    <span class="badge bg-info" id="statusBadge">ุฌุงุฑู ุงูุชุญุถูุฑ...</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="statusMessage">ุจุฏุก ุนูููุฉ ุงูุงุณุชุฎุฑุงุฌ...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-primary" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-md-3">
                            <small class="text-muted">ูุนุฑู ุงูุนูููุฉ</small>
                            <div class="fw-bold" id="extractionId">-</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">ููุช ุงูุจุฏุก</small>
                            <div class="fw-bold" id="startTime">-</div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">ุงููุฏุฉ ุงูููุฏุฑุฉ</small>
                            <div class="fw-bold" id="estimatedTime">-</div>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-sm btn-outline-danger" id="cancelBtn" style="display: none;">
                                ุฅูุบุงุก
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Card -->
            <div class="card shadow-sm border-0" id="resultsCard" style="display: none;">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i data-feather="check-circle"></i> ูุชุงุฆุฌ ุงูุงุณุชุฎุฑุงุฌ</h5>
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            ุชุญููู
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-download="json">
                                <i data-feather="file-text"></i> ููู JSON
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-download="csv">
                                <i data-feather="table"></i> ููู CSV
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-download="site">
                                <i data-feather="globe"></i> ุงููููุน ุงููุณุชูุณุฎ
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Summary Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3 text-center">
                            <div class="border rounded p-3">
                                <h4 class="text-primary mb-1" id="pagesCount">0</h4>
                                <small class="text-muted">ุตูุญุงุช ูุณุชุฎุฑุฌุฉ</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="border rounded p-3">
                                <h4 class="text-success mb-1" id="assetsCount">0</h4>
                                <small class="text-muted">ุฃุตูู ูุญููุฉ</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="border rounded p-3">
                                <h4 class="text-info mb-1" id="techCount">0</h4>
                                <small class="text-muted">ุชูููุงุช ููุชุดูุฉ</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="border rounded p-3">
                                <h4 class="text-warning mb-1" id="qualityScore">0</h4>
                                <small class="text-muted">ููุงุท ุงูุฌูุฏุฉ</small>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Results Tabs -->
                    <ul class="nav nav-tabs mb-3" id="resultsTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#summaryTab">
                                ุงูููุฎุต
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#comparisonTab">
                                ุงูููุงุฑูุฉ
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#technologiesTab">
                                ุงูุชูููุงุช
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#recommendationsTab">
                                ุงูุชูุตูุงุช
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="summaryTab">
                            <div id="summaryContent">
                                <!-- Summary content will be populated here -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="comparisonTab">
                            <div id="comparisonContent">
                                <!-- Comparison content will be populated here -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="technologiesTab">
                            <div id="technologiesContent">
                                <!-- Technologies content will be populated here -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="recommendationsTab">
                            <div id="recommendationsContent">
                                <!-- Recommendations content will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('clonerForm');
    const statusCard = document.getElementById('statusCard');
    const resultsCard = document.getElementById('resultsCard');
    
    let currentExtractionId = null;
    let statusInterval = null;
    
    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Convert checkboxes to booleans
        data.extract_assets = formData.has('extract_assets');
        data.analyze_with_ai = formData.has('analyze_with_ai');
        data.generate_reports = formData.has('generate_reports');
        data.use_hybrid = formData.has('use_hybrid');
        
        try {
            // Start extraction
            const response = await fetch('/api/website-cloner/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentExtractionId = result.extraction_id;
                showStatusCard(result);
                startStatusPolling();
            } else {
                alert('ุฎุทุฃ: ' + result.error);
            }
        } catch (error) {
            alert('ุฎุทุฃ ูู ุงูุงุชุตุงู: ' + error.message);
        }
    });
    
    function showStatusCard(result) {
        statusCard.style.display = 'block';
        resultsCard.style.display = 'none';
        
        document.getElementById('extractionId').textContent = result.extraction_id;
        document.getElementById('startTime').textContent = new Date().toLocaleTimeString('ar');
        document.getElementById('statusBadge').textContent = 'ุฌุงุฑู ุงูุชุดุบูู...';
        document.getElementById('statusBadge').className = 'badge bg-warning';
    }
    
    function startStatusPolling() {
        if (statusInterval) clearInterval(statusInterval);
        
        statusInterval = setInterval(async () => {
            if (!currentExtractionId) return;
            
            try {
                const response = await fetch(`/api/website-cloner/status/${currentExtractionId}`);
                const status = await response.json();
                
                if (status.success) {
                    updateStatus(status);
                    
                    if (status.status === 'completed') {
                        clearInterval(statusInterval);
                        await loadResults();
                    } else if (status.status === 'failed') {
                        clearInterval(statusInterval);
                        showError(status.error);
                    }
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุญุตูู ุนูู ุงูุญุงูุฉ:', error);
            }
        }, 2000); // Poll every 2 seconds
    }
    
    function updateStatus(status) {
        document.getElementById('statusMessage').textContent = status.message;
        document.getElementById('progressPercent').textContent = status.progress + '%';
        document.getElementById('progressBar').style.width = status.progress + '%';
        
        if (status.progress === 100) {
            document.getElementById('statusBadge').textContent = 'ููุชูู';
            document.getElementById('statusBadge').className = 'badge bg-success';
        }
    }
    
    async function loadResults() {
        try {
            const response = await fetch(`/api/website-cloner/results/${currentExtractionId}`);
            const results = await response.json();
            
            if (results.success) {
                showResults(results);
            } else {
                showError(results.error);
            }
        } catch (error) {
            showError('ุฎุทุฃ ูู ุงูุญุตูู ุนูู ุงููุชุงุฆุฌ: ' + error.message);
        }
    }
    
    function showResults(results) {
        resultsCard.style.display = 'block';
        
        // Update summary stats
        const summary = results.website_cloner_summary || {};
        document.getElementById('pagesCount').textContent = summary.pages_extracted || 0;
        document.getElementById('assetsCount').textContent = summary.assets_downloaded || 0;
        document.getElementById('techCount').textContent = (summary.technologies_detected || []).length;
        
        const integratedSummary = results.integrated_summary || {};
        document.getElementById('qualityScore').textContent = integratedSummary.quality_score || 0;
        
        // Populate tabs
        populateSummaryTab(results);
        populateComparisonTab(results);
        populateTechnologiesTab(results);
        populateRecommendationsTab(results);
        
        // Setup download links
        setupDownloadLinks();
    }
    
    function populateSummaryTab(results) {
        const summary = results.website_cloner_summary || {};
        const content = document.getElementById('summaryContent');
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>ูุนูููุงุช ุนุงูุฉ</h6>
                    <ul class="list-unstyled">
                        <li><strong>ุงููุฏู:</strong> ${results.summary?.target_url || '-'}</li>
                        <li><strong>ุงูุฃุฏุงุฉ ุงููุณุชุฎุฏูุฉ:</strong> ${results.summary?.primary_tool || '-'}</li>
                        <li><strong>ุงููุฏุฉ:</strong> ${results.summary?.duration ? results.summary.duration.toFixed(2) + ' ุซุงููุฉ' : '-'}</li>
                        <li><strong>ุงููุฌุงุญ:</strong> ${summary.success ? 'โ ูุนู' : 'โ ูุง'}</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>ุฅุญุตุงุฆูุงุช ุงูุงุณุชุฎุฑุงุฌ</h6>
                    <ul class="list-unstyled">
                        <li><strong>ุงูุตูุญุงุช:</strong> ${summary.pages_extracted || 0}</li>
                        <li><strong>ุงูุฃุตูู:</strong> ${summary.assets_downloaded || 0}</li>
                        <li><strong>ุงูุญุฌู ุงูุฅุฌูุงูู:</strong> ${summary.total_size ? (summary.total_size / 1024).toFixed(1) + ' KB' : '-'}</li>
                        <li><strong>ุงููุฌูุฏ:</strong> ${summary.output_path || '-'}</li>
                    </ul>
                </div>
            </div>
        `;
    }
    
    function populateComparisonTab(results) {
        const comparison = results.comparison_analysis || {};
        const content = document.getElementById('comparisonContent');
        
        if (Object.keys(comparison).length === 0) {
            content.innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ููุงุฑูุฉ ูุชุงุญุฉ - ูู ูุชู ุงุณุชุฎุฏุงู ุงููุธุงู ุงููุฌูู</p>';
            return;
        }
        
        content.innerHTML = `
            <h6>ูุชุงุฆุฌ ุงูููุงุฑูุฉ</h6>
            <div class="alert alert-info">
                <strong>ุงูุชูุตูุฉ:</strong> ${comparison.recommendation || 'ุบูุฑ ูุชููุฑ'}
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6>ููุงุฑูุฉ ุงูุณุฑุนุฉ</h6>
                    ${comparison.extraction_speed ? `
                        <ul class="list-unstyled">
                            <li>Website Cloner Pro: ${comparison.extraction_speed.website_cloner_pro}</li>
                            <li>ุงูุฃุฏูุงุช ุงูุญุงููุฉ: ${comparison.extraction_speed.unified_extractor}</li>
                            <li><strong>ุงูุฃุณุฑุน:</strong> ${comparison.extraction_speed.faster_tool}</li>
                        </ul>
                    ` : '<p class="text-muted">ุบูุฑ ูุชููุฑ</p>'}
                </div>
                <div class="col-md-6">
                    <h6>ููุงุฑูุฉ ุงูุฌูุฏุฉ</h6>
                    ${comparison.content_quality ? `
                        <ul class="list-unstyled">
                            <li>Website Cloner Pro: ${comparison.content_quality.website_cloner_pro_pages} ุตูุญุฉ</li>
                            <li>ุงูุฃุฏูุงุช ุงูุญุงููุฉ: ${comparison.content_quality.unified_extractor_pages} ุตูุญุฉ</li>
                            <li><strong>ุงูุฃูุถู:</strong> ${comparison.content_quality.better_coverage}</li>
                        </ul>
                    ` : '<p class="text-muted">ุบูุฑ ูุชููุฑ</p>'}
                </div>
            </div>
        `;
    }
    
    function populateTechnologiesTab(results) {
        const technologies = results.integrated_summary?.combined_technologies || 
                           results.website_cloner_summary?.technologies_detected || [];
        const content = document.getElementById('technologiesContent');
        
        if (technologies.length === 0) {
            content.innerHTML = '<p class="text-muted">ูู ูุชู ุงูุชุดุงู ุชูููุงุช ูุญุฏุฏุฉ</p>';
            return;
        }
        
        const techList = technologies.map(tech => `
            <span class="badge bg-primary me-2 mb-2">${tech}</span>
        `).join('');
        
        content.innerHTML = `
            <h6>ุงูุชูููุงุช ุงูููุชุดูุฉ (${technologies.length})</h6>
            <div class="mb-3">${techList}</div>
            <h6>ุชูุงุตูู ุงูุชูููุงุช</h6>
            <div class="row">
                ${technologies.map(tech => `
                    <div class="col-md-4 mb-2">
                        <div class="border rounded p-2 text-center">
                            <small class="text-muted">${tech}</small>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function populateRecommendationsTab(results) {
        const recommendations = results.recommendations || [];
        const content = document.getElementById('recommendationsContent');
        
        if (recommendations.length === 0) {
            content.innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ุชูุตูุงุช ูุชุงุญุฉ</p>';
            return;
        }
        
        const recList = recommendations.map((rec, index) => `
            <div class="alert alert-info">
                <strong>${index + 1}.</strong> ${rec}
            </div>
        `).join('');
        
        content.innerHTML = `
            <h6>ุงูุชูุตูุงุช (${recommendations.length})</h6>
            ${recList}
        `;
    }
    
    function setupDownloadLinks() {
        document.querySelectorAll('[data-download]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const type = this.dataset.download;
                if (currentExtractionId) {
                    window.open(`/api/website-cloner/download/${currentExtractionId}/${type}`, '_blank');
                }
            });
        });
    }
    
    function showError(error) {
        document.getElementById('statusBadge').textContent = 'ูุดู';
        document.getElementById('statusBadge').className = 'badge bg-danger';
        document.getElementById('statusMessage').textContent = 'ุฎุทุฃ: ' + error;
    }
});
</script>
{% endblock %}