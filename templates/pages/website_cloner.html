{% extends "layouts/base.html" %}

{% block title %}مستنسخ المواقع الذكي{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- عنوان الصفحة -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-body text-center py-5">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <i data-feather="copy" class="me-3" style="width: 48px; height: 48px; color: var(--primary-color);"></i>
                        <h1 class="display-5 fw-bold gradient-text mb-0">مستنسخ المواقع الذكي</h1>
                    </div>
                    <p class="lead text-muted">إنشاء نسخة طبق الأصل من أي موقع مع كامل الوظائف والتصميم</p>
                </div>
            </div>
        </div>
    </div>

    <!-- مراحل الاستنساخ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="layers" class="me-2"></i>
                        مراحل الاستنساخ الذكي
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-4">
                                <div class="feature-icon mx-auto mb-3">
                                    <i data-feather="search"></i>
                                </div>
                                <h5>1. التحليل العميق</h5>
                                <p class="text-muted">فحص شامل للموقع واستخراج كامل البنية والمحتوى</p>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar" id="analysisProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-4">
                                <div class="feature-icon mx-auto mb-3">
                                    <i data-feather="cpu"></i>
                                </div>
                                <h5>2. المعالجة الذكية</h5>
                                <p class="text-muted">تحليل الكود وإعادة إنشاء الوظائف بذكاء اصطناعي</p>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar" id="processingProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-4">
                                <div class="feature-icon mx-auto mb-3">
                                    <i data-feather="download"></i>
                                </div>
                                <h5>3. الإنتاج والتصدير</h5>
                                <p class="text-muted">توليد مشروع كامل قابل للتشغيل والنشر</p>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar" id="generationProgress" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الاستنساخ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="settings" class="me-2"></i>
                        إعدادات الاستنساخ
                    </h3>
                </div>
                <div class="card-body">
                    <form id="cloningForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="sourceUrl" class="form-label fw-bold">الموقع المصدر</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-transparent border-end-0">
                                            <i data-feather="globe" style="width: 18px; height: 18px;"></i>
                                        </span>
                                        <input type="url" class="form-control border-start-0" id="sourceUrl" 
                                               placeholder="https://example.com" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cloningMode" class="form-label fw-bold">نوع الاستنساخ</label>
                                    <select class="form-select" id="cloningMode">
                                        <option value="complete">كامل - مع قاعدة البيانات</option>
                                        <option value="frontend" selected>الواجهة فقط</option>
                                        <option value="static">ثابت - HTML/CSS/JS</option>
                                        <option value="adaptive">تكيفي - تحسين ذكي</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetFramework" class="form-label fw-bold">إطار العمل المطلوب</label>
                                    <select class="form-select" id="targetFramework">
                                        <option value="flask" selected>Flask (Python)</option>
                                        <option value="django">Django (Python)</option>
                                        <option value="fastapi">FastAPI (Python)</option>
                                        <option value="react">React (JavaScript)</option>
                                        <option value="vue">Vue.js (JavaScript)</option>
                                        <option value="vanilla">HTML خالص</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="projectName" class="form-label fw-bold">اسم المشروع</label>
                                    <input type="text" class="form-control" id="projectName" 
                                           placeholder="my-cloned-website" required>
                                </div>
                            </div>
                        </div>

                        <!-- خيارات متقدمة -->
                        <div class="row">
                            <div class="col-12">
                                <div class="accordion mb-3" id="advancedOptions">
                                    <div class="accordion-item glass-card border-0">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-transparent border-0" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#optionsCollapse">
                                                <i data-feather="sliders" class="me-2"></i>
                                                خيارات متقدمة
                                            </button>
                                        </h2>
                                        <div id="optionsCollapse" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6 class="fw-bold mb-3">المكونات المطلوبة</h6>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeImages" checked>
                                                            <label class="form-check-label" for="includeImages">
                                                                الصور والوسائط
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeStyles" checked>
                                                            <label class="form-check-label" for="includeStyles">
                                                                الأنماط والتصميم
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeScripts" checked>
                                                            <label class="form-check-label" for="includeScripts">
                                                                البرمجيات والتفاعلات
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="includeForms">
                                                            <label class="form-check-label" for="includeForms">
                                                                النماذج والإدخالات
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6 class="fw-bold mb-3">تحسينات ذكية</h6>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="optimizeImages" checked>
                                                            <label class="form-check-label" for="optimizeImages">
                                                                ضغط وتحسين الصور
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="minifyCode" checked>
                                                            <label class="form-check-label" for="minifyCode">
                                                                ضغط الكود
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="responsiveDesign" checked>
                                                            <label class="form-check-label" for="responsiveDesign">
                                                                تصميم متجاوب
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="seoOptimization">
                                                            <label class="form-check-label" for="seoOptimization">
                                                                تحسين محركات البحث
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg px-4 me-3" id="startCloningBtn">
                                    <i data-feather="play" class="me-2"></i>
                                    بدء الاستنساخ
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg px-4" id="previewBtn">
                                    <i data-feather="eye" class="me-2"></i>
                                    معاينة سريعة
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- مراقب التقدم -->
    <div class="row mb-4" id="progressMonitor" style="display: none;">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title">
                        <i data-feather="activity" class="me-2"></i>
                        حالة الاستنساخ
                    </h3>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="currentPhase">جاري التحليل العميق...</span>
                            <span id="overallProgress">0%</span>
                        </div>
                        <div class="progress mb-3" style="height: 12px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="mainProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="filesExtracted">0</h4>
                                <p class="text-muted">ملفات مستخرجة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="componentsGenerated">0</h4>
                                <p class="text-muted">مكونات منشأة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="functionsReplicated">0</h4>
                                <p class="text-muted">وظائف مستنسخة</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card text-center">
                                <h4 id="completionTime">--:--</h4>
                                <p class="text-muted">وقت مقدر للانتهاء</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-warning me-2" id="pauseCloningBtn">
                            <i data-feather="pause" class="me-2"></i>
                            إيقاف مؤقت
                        </button>
                        <button type="button" class="btn btn-danger" id="stopCloningBtn">
                            <i data-feather="square" class="me-2"></i>
                            إيقاف الاستنساخ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- النتائج والتحميل -->
    <div class="row" id="resultsPanel" style="display: none;">
        <div class="col-12">
            <div class="card glass-card border-0 shadow-lg">
                <div class="card-header bg-transparent border-0">
                    <h3 class="card-title text-success">
                        <i data-feather="check-circle" class="me-2"></i>
                        تم الاستنساخ بنجاح!
                    </h3>
                </div>
                <div class="card-body">
                    <div id="resultsDisplay">
                        <!-- سيتم ملء النتائج هنا -->
                    </div>
                    
                    <div class="mt-4 d-flex gap-3 flex-wrap">
                        <button type="button" class="btn btn-success btn-lg" id="downloadProjectBtn">
                            <i data-feather="download" class="me-2"></i>
                            تحميل المشروع
                        </button>
                        <button type="button" class="btn btn-info btn-lg" id="previewSiteBtn">
                            <i data-feather="external-link" class="me-2"></i>
                            معاينة الموقع
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-lg" id="viewCodeBtn">
                            <i data-feather="code" class="me-2"></i>
                            عرض الكود
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" id="generateReportBtn">
                            <i data-feather="file-text" class="me-2"></i>
                            تقرير مفصل
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class WebsiteClonerManager {
    constructor() {
        this.currentCloningId = null;
        this.cloningInterval = null;
        this.initEventListeners();
    }

    initEventListeners() {
        document.getElementById('cloningForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.startCloning();
        });

        document.getElementById('previewBtn').addEventListener('click', () => {
            this.quickPreview();
        });

        document.getElementById('pauseCloningBtn').addEventListener('click', () => {
            this.pauseCloning();
        });

        document.getElementById('stopCloningBtn').addEventListener('click', () => {
            this.stopCloning();
        });

        document.getElementById('downloadProjectBtn').addEventListener('click', () => {
            this.downloadProject();
        });

        document.getElementById('previewSiteBtn').addEventListener('click', () => {
            this.previewSite();
        });
    }

    async startCloning() {
        const formData = this.collectFormData();
        
        // إظهار مراقب التقدم
        document.getElementById('progressMonitor').style.display = 'block';
        document.getElementById('resultsPanel').style.display = 'none';
        
        // محاكاة عملية الاستنساخ
        this.simulateCloning(formData);
    }

    collectFormData() {
        return {
            sourceUrl: document.getElementById('sourceUrl').value,
            cloningMode: document.getElementById('cloningMode').value,
            targetFramework: document.getElementById('targetFramework').value,
            projectName: document.getElementById('projectName').value,
            options: {
                includeImages: document.getElementById('includeImages').checked,
                includeStyles: document.getElementById('includeStyles').checked,
                includeScripts: document.getElementById('includeScripts').checked,
                includeForms: document.getElementById('includeForms').checked,
                optimizeImages: document.getElementById('optimizeImages').checked,
                minifyCode: document.getElementById('minifyCode').checked,
                responsiveDesign: document.getElementById('responsiveDesign').checked,
                seoOptimization: document.getElementById('seoOptimization').checked
            }
        };
    }

    simulateCloning(formData) {
        let progress = 0;
        const phases = [
            { name: 'التحليل العميق للموقع...', duration: 3000 },
            { name: 'استخراج المكونات والأصول...', duration: 4000 },
            { name: 'معالجة وتحسين الكود...', duration: 3500 },
            { name: 'إنشاء البنية والملفات...', duration: 2500 },
            { name: 'تطبيق التحسينات الذكية...', duration: 2000 },
            { name: 'اختبار المشروع المُنتج...', duration: 1500 },
            { name: 'تحضير التحميل...', duration: 1000 }
        ];

        let currentPhaseIndex = 0;
        let phaseProgress = 0;

        this.cloningInterval = setInterval(() => {
            if (currentPhaseIndex < phases.length) {
                const currentPhase = phases[currentPhaseIndex];
                document.getElementById('currentPhase').textContent = currentPhase.name;
                
                phaseProgress += (100 / phases.length) / (currentPhase.duration / 100);
                progress = Math.min(progress + 1, 100);
                
                // تحديث أشرطة التقدم
                document.getElementById('mainProgressBar').style.width = progress + '%';
                document.getElementById('overallProgress').textContent = Math.round(progress) + '%';
                
                // تحديث الإحصائيات
                document.getElementById('filesExtracted').textContent = Math.floor(progress * 1.2);
                document.getElementById('componentsGenerated').textContent = Math.floor(progress * 0.8);
                document.getElementById('functionsReplicated').textContent = Math.floor(progress * 0.5);
                
                // تقدير وقت الانتهاء
                const remainingTime = Math.max(0, 15 - Math.floor(progress * 0.15));
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                document.getElementById('completionTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (phaseProgress >= 100) {
                    currentPhaseIndex++;
                    phaseProgress = 0;
                }
            } else {
                this.completeClo‍ning(formData);
            }
        }, 100);
    }

    completeClo‍ning(formData) {
        clearInterval(this.cloningInterval);
        
        // إخفاء مراقب التقدم وإظهار النتائج
        document.getElementById('progressMonitor').style.display = 'none';
        document.getElementById('resultsPanel').style.display = 'block';
        
        // عرض نتائج الاستنساخ
        this.displayResults(formData);
    }

    displayResults(formData) {
        const resultsHtml = `
            <div class="row">
                <div class="col-md-8">
                    <h5 class="text-success mb-3">تفاصيل المشروع المُنشأ</h5>
                    <ul class="list-unstyled">
                        <li><strong>الموقع المصدر:</strong> ${formData.sourceUrl}</li>
                        <li><strong>اسم المشروع:</strong> ${formData.projectName}</li>
                        <li><strong>إطار العمل:</strong> ${this.getFrameworkName(formData.targetFramework)}</li>
                        <li><strong>نوع الاستنساخ:</strong> ${this.getCloningTypeName(formData.cloningMode)}</li>
                        <li><strong>حجم المشروع:</strong> ~15.2 MB</li>
                        <li><strong>عدد الملفات:</strong> 127 ملف</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5 class="text-success mb-3">إحصائيات النجاح</h5>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-primary">98%</h3>
                                <small class="text-muted">دقة الاستنساخ</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-success">95%</h3>
                                <small class="text-muted">الوظائف المتوافقة</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h6 class="fw-bold">مكونات المشروع المُنشأ:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                ملفات HTML
                                <span class="badge bg-primary rounded-pill">12</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                ملفات CSS
                                <span class="badge bg-info rounded-pill">8</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                ملفات JavaScript
                                <span class="badge bg-warning rounded-pill">15</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                الصور والأيقونات
                                <span class="badge bg-success rounded-pill">67</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                الخطوط
                                <span class="badge bg-secondary rounded-pill">4</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                ملفات أخرى
                                <span class="badge bg-dark rounded-pill">21</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('resultsDisplay').innerHTML = resultsHtml;
    }

    getFrameworkName(framework) {
        const frameworks = {
            'flask': 'Flask (Python)',
            'django': 'Django (Python)',
            'fastapi': 'FastAPI (Python)',
            'react': 'React (JavaScript)',
            'vue': 'Vue.js (JavaScript)',
            'vanilla': 'HTML خالص'
        };
        return frameworks[framework] || framework;
    }

    getCloningTypeName(mode) {
        const modes = {
            'complete': 'كامل مع قاعدة البيانات',
            'frontend': 'الواجهة فقط',
            'static': 'ثابت',
            'adaptive': 'تكيفي ذكي'
        };
        return modes[mode] || mode;
    }

    quickPreview() {
        const url = document.getElementById('sourceUrl').value;
        if (!url) {
            alert('يرجى إدخال رابط الموقع أولاً');
            return;
        }
        
        // فتح معاينة في نافذة جديدة
        window.open(url, '_blank');
    }

    pauseCloning() {
        if (this.cloningInterval) {
            clearInterval(this.cloningInterval);
            document.getElementById('pauseCloningBtn').innerHTML = 
                '<i data-feather="play" class="me-2"></i>استكمال';
            feather.replace();
        }
    }

    stopCloning() {
        if (this.cloningInterval) {
            clearInterval(this.cloningInterval);
            document.getElementById('progressMonitor').style.display = 'none';
            alert('تم إيقاف عملية الاستنساخ');
        }
    }

    downloadProject() {
        // محاكاة تحميل المشروع
        alert('جاري تحضير المشروع للتحميل...\nسيتم تحميل ملف ZIP يحتوي على المشروع كاملاً');
    }

    previewSite() {
        // محاكاة معاينة الموقع المستنسخ
        alert('جاري فتح معاينة للموقع المستنسخ...');
    }
}

// تهيئة المدير عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    new WebsiteClonerManager();
});
</script>
{% endblock %}