{% extends "base.html" %}

{% block title %}أداة الاستخراج المتطورة - Website Analyzer{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <h1 class="h2 text-primary mb-3">
                    <i data-feather="download" class="me-2"></i>
                    أداة الاستخراج المتطورة والآمنة
                </h1>
                <p class="text-muted">
                    استخراج آمن ومسؤول لمحتوى المواقع مع نظام الموافقات المتقدم
                </p>
                
                <!-- Security Notice -->
                <div class="alert alert-info border-0 bg-info bg-opacity-10">
                    <div class="d-flex align-items-center">
                        <i data-feather="shield" class="text-info me-2"></i>
                        <strong>ملاحظة أمنية:</strong> 
                        هذه الأداة تتطلب موافقة صريحة لكل عملية. لن يتم تنفيذ أي إجراء بدون إذنك المسبق.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Extraction Interface -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Step 1: URL Input and Analysis -->
            <div class="glass-card p-4 mb-4" id="step-1">
                <h3 class="h4 mb-3">
                    <span class="badge bg-primary me-2">1</span>
                    تحليل الموقع المراد استخراجه
                </h3>
                
                <form id="analysisForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="targetUrl" class="form-label">رابط الموقع</label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary text-white">
                                    <i data-feather="link" width="16"></i>
                                </span>
                                <input type="url" class="form-control" id="targetUrl" 
                                       placeholder="https://example.com" required>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="extractionLevel" class="form-label">مستوى الاستخراج</label>
                            <select class="form-select" id="extractionLevel">
                                <option value="basic">أساسي - HTML فقط</option>
                                <option value="standard" selected>عادي - HTML + CSS + صور</option>
                                <option value="advanced">متقدم - شامل مع JavaScript</option>
                                <option value="complete">كامل - جميع الملفات</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="maxPages" class="form-label">عدد الصفحات</label>
                            <input type="number" class="form-control" id="maxPages" 
                                   value="5" min="1" max="20">
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="removeAds" checked>
                                <label class="form-check-label" for="removeAds">
                                    إزالة الإعلانات
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="respectRobots" checked>
                                <label class="form-check-label" for="respectRobots">
                                    احترام robots.txt
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100 mt-4">
                                <i data-feather="search" width="16" class="me-1"></i>
                                تحليل الموقع
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Analysis Progress -->
                <div id="analysisProgress" class="mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                        <span>جاري تحليل الموقع...</span>
                    </div>
                </div>
            </div>

            <!-- Step 2: Preview and Permissions -->
            <div class="glass-card p-4 mb-4" id="step-2" style="display: none;">
                <h3 class="h4 mb-3">
                    <span class="badge bg-warning me-2">2</span>
                    معاينة الاستخراج والأذونات
                </h3>
                
                <!-- Extraction Preview -->
                <div id="extractionPreview" class="row g-3 mb-4">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                
                <!-- Permissions Request -->
                <div id="permissionsSection" class="alert alert-warning">
                    <h5 class="alert-heading">
                        <i data-feather="lock" class="me-2"></i>
                        الأذونات المطلوبة
                    </h5>
                    <div id="permissionsList">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="approveAll">
                            <label class="form-check-label" for="approveAll">
                                أوافق على جميع الأذونات المطلوبة أعلاه
                            </label>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-success me-2" id="approvePermissions" disabled>
                                <i data-feather="check" width="16" class="me-1"></i>
                                الموافقة والمتابعة
                            </button>
                            <button class="btn btn-secondary" id="cancelExtraction">
                                <i data-feather="x" width="16" class="me-1"></i>
                                إلغاء
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Extraction Progress -->
            <div class="glass-card p-4 mb-4" id="step-3" style="display: none;">
                <h3 class="h4 mb-3">
                    <span class="badge bg-success me-2">3</span>
                    تقدم عملية الاستخراج
                </h3>
                
                <div id="extractionStatus" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>الحالة: <span id="statusText">جاري التحضير...</span></span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Live Statistics -->
                <div class="row g-3" id="liveStats" style="display: none;">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-primary" id="pagesCount">0</div>
                            <small class="text-muted">صفحات مستخرجة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-success" id="filesCount">0</div>
                            <small class="text-muted">ملفات محفوظة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-warning" id="adsCount">0</div>
                            <small class="text-muted">إعلانات محذوفة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h4 text-info" id="sizeCount">0 MB</div>
                            <small class="text-muted">حجم البيانات</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="glass-card p-4 mb-4" id="step-4" style="display: none;">
                <h3 class="h4 mb-3">
                    <span class="badge bg-success me-2">4</span>
                    نتائج الاستخراج
                </h3>
                
                <div id="extractionResults">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-primary me-2" id="downloadResults">
                        <i data-feather="download" width="16" class="me-1"></i>
                        تحميل النتائج
                    </button>
                    <button class="btn btn-outline-secondary" id="startNewExtraction">
                        <i data-feather="plus" width="16" class="me-1"></i>
                        استخراج جديد
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar: Tips and History -->
        <div class="col-lg-4">
            <!-- Security Tips -->
            <div class="glass-card p-4 mb-4">
                <h5 class="h6 mb-3">
                    <i data-feather="info" class="me-2"></i>
                    نصائح الأمان
                </h5>
                
                <div class="small text-muted">
                    <div class="mb-2">
                        <i data-feather="shield" width="14" class="me-1 text-success"></i>
                        جميع العمليات تتطلب موافقة صريحة
                    </div>
                    <div class="mb-2">
                        <i data-feather="eye" width="14" class="me-1 text-info"></i>
                        يمكنك معاينة كل شيء قبل التنفيذ
                    </div>
                    <div class="mb-2">
                        <i data-feather="x-circle" width="14" class="me-1 text-warning"></i>
                        يمكن إلغاء العملية في أي وقت
                    </div>
                    <div>
                        <i data-feather="clock" width="14" class="me-1 text-secondary"></i>
                        احترام معدل الطلبات للمواقع
                    </div>
                </div>
            </div>

            <!-- Quick Settings -->
            <div class="glass-card p-4 mb-4">
                <h5 class="h6 mb-3">
                    <i data-feather="settings" class="me-2"></i>
                    إعدادات سريعة
                </h5>
                
                <div class="row g-2">
                    <div class="col-6">
                        <label for="requestDelay" class="form-label small">تأخير الطلبات (ثانية)</label>
                        <input type="number" class="form-control form-control-sm" 
                               id="requestDelay" value="1" min="0.5" max="5" step="0.5">
                    </div>
                    <div class="col-6">
                        <label for="maxDepth" class="form-label small">عمق الاستخراج</label>
                        <select class="form-select form-select-sm" id="maxDepth">
                            <option value="1">مستوى واحد</option>
                            <option value="2" selected>مستويان</option>
                            <option value="3">ثلاثة مستويات</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Recent Extractions -->
            <div class="glass-card p-4">
                <h5 class="h6 mb-3">
                    <i data-feather="clock" class="me-2"></i>
                    عمليات الاستخراج الأخيرة
                </h5>
                
                <div id="recentExtractions" class="text-muted">
                    <div class="text-center py-3">
                        <small>لا توجد عمليات استخراج سابقة</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Extractor JavaScript -->
<script>
class AdvancedExtractor {
    constructor() {
        this.sessionId = null;
        this.currentStep = 1;
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadRecentExtractions();
    }

    bindEvents() {
        // Analysis form
        document.getElementById('analysisForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.analyzeWebsite();
        });

        // Approve all checkbox
        document.getElementById('approveAll').addEventListener('change', (e) => {
            document.getElementById('approvePermissions').disabled = !e.target.checked;
        });

        // Permission approval
        document.getElementById('approvePermissions').addEventListener('click', () => {
            this.approvePermissions();
        });

        // Cancel extraction
        document.getElementById('cancelExtraction').addEventListener('click', () => {
            this.cancelExtraction();
        });

        // Start new extraction
        document.getElementById('startNewExtraction').addEventListener('click', () => {
            this.resetExtractor();
        });
    }

    async analyzeWebsite() {
        const url = document.getElementById('targetUrl').value;
        const level = document.getElementById('extractionLevel').value;
        const maxPages = parseInt(document.getElementById('maxPages').value);
        const removeAds = document.getElementById('removeAds').checked;

        this.showProgress('analysisProgress');

        try {
            const response = await fetch('/api/extraction/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    level: level,
                    max_pages: maxPages,
                    remove_ads: removeAds
                })
            });

            const data = await response.json();

            if (data.status === 'success') {
                this.sessionId = data.session_id;
                this.showPreview(data.preview);
                this.showStep(2);
            } else {
                this.showError(data.error || 'حدث خطأ في التحليل');
            }
        } catch (error) {
            this.showError('خطأ في الاتصال بالخادم');
        } finally {
            this.hideProgress('analysisProgress');
        }
    }

    showPreview(preview) {
        const previewContainer = document.getElementById('extractionPreview');
        
        previewContainer.innerHTML = `
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">${preview.estimated_pages}</h5>
                        <p class="card-text small">صفحات متوقعة</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">${preview.estimated_images}</h5>
                        <p class="card-text small">صور متوقعة</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h5 class="card-title text-warning">${preview.estimated_size_mb} MB</h5>
                        <p class="card-text small">حجم متوقع</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h5 class="card-title text-info">${Math.floor(preview.extraction_time_estimate / 60)}m</h5>
                        <p class="card-text small">وقت متوقع</p>
                    </div>
                </div>
            </div>
        `;

        // Show detected technologies
        if (preview.detected_technologies.length > 0) {
            previewContainer.innerHTML += `
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>التقنيات المكتشفة:</strong>
                        ${preview.detected_technologies.map(tech => `<span class="badge bg-info me-1">${tech}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        // Show permissions
        this.showRequiredPermissions(preview.required_permissions);
    }

    showRequiredPermissions(permissions) {
        const permissionsList = document.getElementById('permissionsList');
        
        const permissionNames = {
            'read_content': 'قراءة محتوى الموقع',
            'download_images': 'تحميل الصور',
            'extract_css': 'استخراج ملفات CSS',
            'extract_js': 'استخراج ملفات JavaScript',
            'modify_code': 'تعديل الكود',
            'remove_ads': 'إزالة الإعلانات',
            'save_to_disk': 'حفظ الملفات على القرص'
        };

        permissionsList.innerHTML = permissions.map(perm => `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" disabled checked>
                <label class="form-check-label">
                    ${permissionNames[perm] || perm}
                </label>
            </div>
        `).join('');
    }

    async approvePermissions() {
        if (!this.sessionId) return;

        try {
            const response = await fetch('/api/extraction/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: this.sessionId,
                    confirmed: true
                })
            });

            const data = await response.json();

            if (data.status === 'completed') {
                this.showResults(data.results);
                this.showStep(4);
            } else {
                this.showError(data.error || 'فشل في بدء الاستخراج');
            }
        } catch (error) {
            this.showError('خطأ في الاتصال');
        }
    }

    showResults(results) {
        const resultsContainer = document.getElementById('extractionResults');
        
        resultsContainer.innerHTML = `
            <div class="alert alert-success">
                <h5 class="alert-heading">تم الاستخراج بنجاح!</h5>
                <p>تم استخراج ${results.pages_extracted.length} صفحة بنجاح.</p>
            </div>
            
            <div class="list-group">
                ${results.pages_extracted.map(page => `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${page.title}</h6>
                            <small>تم الحفظ</small>
                        </div>
                        <p class="mb-1">${page.url}</p>
                        <small>التعديلات: ${page.modifications.join(', ')}</small>
                    </div>
                `).join('')}
            </div>
        `;
    }

    showStep(stepNumber) {
        // Hide all steps
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step-${i}`).style.display = 'none';
        }
        
        // Show current and previous steps
        for (let i = 1; i <= stepNumber; i++) {
            document.getElementById(`step-${i}`).style.display = 'block';
        }
        
        this.currentStep = stepNumber;
    }

    showProgress(elementId) {
        document.getElementById(elementId).style.display = 'block';
    }

    hideProgress(elementId) {
        document.getElementById(elementId).style.display = 'none';
    }

    showError(message) {
        // يمكن تحسين هذا لإظهار الأخطاء بشكل أفضل
        alert(message);
    }

    cancelExtraction() {
        this.resetExtractor();
    }

    resetExtractor() {
        this.sessionId = null;
        this.showStep(1);
        document.getElementById('targetUrl').value = '';
        document.getElementById('approveAll').checked = false;
    }

    loadRecentExtractions() {
        // يمكن تحميل العمليات الأخيرة من الخادم
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new AdvancedExtractor();
    
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>
{% endblock %}