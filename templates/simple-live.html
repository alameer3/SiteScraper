{% extends "base.html" %}

{% block title %}التحليل المباشر - {{ result.url }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Live Analysis Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h1 class="h3 mb-2">
                        <i data-feather="activity" class="me-2"></i>
                        التحليل المباشر للموقع
                    </h1>
                    <p class="mb-0">
                        <i data-feather="link" class="me-1"></i>
                        {{ result.url }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">تقدم التحليل</h4>
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             id="progressBar" 
                             style="width: 0%"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">0%</div>
                    </div>
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="step-indicator" id="step1">
                                <div class="step-number">1</div>
                                <div class="step-label">جمع البيانات</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator" id="step2">
                                <div class="step-number">2</div>
                                <div class="step-label">تحليل التقنيات</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator" id="step3">
                                <div class="step-number">3</div>
                                <div class="step-label">استخراج الأصول</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step-indicator" id="step4">
                                <div class="step-number">4</div>
                                <div class="step-label">إنهاء التحليل</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Stats -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">إحصائيات مباشرة</h4>
                    <div class="stat-item mb-3">
                        <strong>الصفحات المفحوصة:</strong>
                        <span class="badge bg-primary" id="pagesCount">0</span>
                    </div>
                    <div class="stat-item mb-3">
                        <strong>الصور المكتشفة:</strong>
                        <span class="badge bg-info" id="imagesCount">0</span>
                    </div>
                    <div class="stat-item mb-3">
                        <strong>التقنيات المحددة:</strong>
                        <span class="badge bg-success" id="techCount">0</span>
                    </div>
                    <div class="stat-item mb-3">
                        <strong>الإعلانات المحجوبة:</strong>
                        <span class="badge bg-warning" id="adsCount">0</span>
                    </div>
                    <hr>
                    <div class="text-center">
                        <strong>الوقت المنقضي:</strong>
                        <div class="h5 text-primary" id="elapsedTime">00:00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Feed -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">سجل الأنشطة المباشر</h4>
                    <div id="activityFeed" class="activity-feed">
                        <div class="activity-item">
                            <span class="activity-time">[تم البدء]</span>
                            <span class="activity-text">بدء التحليل الشامل...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
                        <i data-feather="home" class="me-1"></i>العودة للرئيسية
                    </a>
                    <button class="btn btn-danger" onclick="stopAnalysis()">
                        <i data-feather="square" class="me-1"></i>إيقاف التحليل
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let resultId = {{ result.id }};
let analysisStartTime = Date.now();
let isRunning = true;

document.addEventListener('DOMContentLoaded', function() {
    startLiveUpdates();
    startTimer();
});

function startLiveUpdates() {
    const updateInterval = setInterval(() => {
        if (!isRunning) {
            clearInterval(updateInterval);
            return;
        }
        
        fetch(`/api/live-progress/${resultId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data);
                updateStats(data.stats || {});
                addActivity(data.latest_activity || '');
                
                if (data.status === 'completed' || data.completed) {
                    completeAnalysis();
                    clearInterval(updateInterval);
                }
            })
            .catch(error => {
                console.error('خطأ في التحديث:', error);
                addActivity('خطأ في الاتصال مع الخادم');
            });
    }, 3000);
}

function updateProgress(data) {
    const progress = Math.min(data.progress || 0, 100);
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = progress + '%';
    progressBar.textContent = Math.round(progress) + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    
    // Update steps
    const currentStep = data.current_step || 1;
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
        
        if (i < currentStep) {
            step.classList.add('completed');
        } else if (i === currentStep) {
            step.classList.add('active');
        }
    }
}

function updateStats(stats) {
    document.getElementById('pagesCount').textContent = stats.pages_scanned || 0;
    document.getElementById('imagesCount').textContent = stats.images_found || 0;
    document.getElementById('techCount').textContent = stats.tech_detected || 0;
    document.getElementById('adsCount').textContent = stats.ads_blocked || 0;
}

function addActivity(activity) {
    if (!activity) return;
    
    const feed = document.getElementById('activityFeed');
    const time = new Date().toLocaleTimeString('ar', { hour12: false });
    
    const item = document.createElement('div');
    item.className = 'activity-item';
    item.innerHTML = `
        <span class="activity-time">[${time}]</span>
        <span class="activity-text">${activity}</span>
    `;
    
    feed.insertBefore(item, feed.firstChild);
    
    // Keep only last 15 items
    if (feed.children.length > 15) {
        feed.removeChild(feed.lastChild);
    }
}

function startTimer() {
    setInterval(() => {
        const elapsed = Date.now() - analysisStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('elapsedTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function completeAnalysis() {
    isRunning = false;
    addActivity('تم إكمال التحليل بنجاح! 🎉');
    
    setTimeout(() => {
        window.location.href = `{{ url_for('results', result_id=result.id) }}`;
    }, 2000);
}

function stopAnalysis() {
    if (confirm('هل أنت متأكد من إيقاف التحليل؟')) {
        isRunning = false;
        addActivity('تم إيقاف التحليل بواسطة المستخدم');
        setTimeout(() => {
            window.location.href = '{{ url_for("index") }}';
        }, 1000);
    }
}
</script>

<style>
.step-indicator {
    text-align: center;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.step-indicator.active {
    opacity: 1;
    color: #0d6efd;
    font-weight: bold;
}

.step-indicator.completed {
    opacity: 1;
    color: #198754;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #e9ecef;
    line-height: 30px;
    margin: 0 auto 8px;
    font-weight: bold;
}

.step-indicator.active .step-number {
    background: #0d6efd;
    color: white;
}

.step-indicator.completed .step-number {
    background: #198754;
    color: white;
}

.activity-item {
    padding: 8px 0;
    border-bottom: 1px solid #dee2e6;
    animation: fadeIn 0.3s ease;
}

.activity-time {
    color: #6c757d;
    font-family: monospace;
    margin-right: 10px;
}

.activity-text {
    color: #495057;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.activity-feed {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}