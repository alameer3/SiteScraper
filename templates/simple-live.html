{% extends "base.html" %}

{% block title %}تحليل مباشر - {{ result.url }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="card shadow mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white text-center p-5">
                    <h1 class="h2 mb-3">
                        <i data-feather="activity" class="me-2"></i>
                        تحليل مباشر للموقع
                    </h1>
                    <p class="lead mb-3">{{ result.url }}</p>
                    <div class="d-flex justify-content-center align-items-center">
                        <div class="spinner-border me-2" role="status">
                            <span class="visually-hidden">جاري التحليل...</span>
                        </div>
                        <span id="status-text">جاري تحليل الموقع...</span>
                    </div>
                </div>
            </div>

            <!-- Progress Card -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i data-feather="trending-up" class="me-2"></i>
                        تقدم التحليل
                    </h5>
                    
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progress-bar" 
                             role="progressbar" 
                             style="width: 0%">
                            <span id="progress-text">0%</span>
                        </div>
                    </div>

                    <!-- Steps -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="step" id="step-1">
                                <div class="step-icon bg-primary text-white rounded-circle mx-auto mb-2" style="width: 50px; height: 50px; line-height: 50px;">
                                    <i data-feather="download" width="20" height="20"></i>
                                </div>
                                <small>جمع البيانات</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step" id="step-2">
                                <div class="step-icon bg-secondary text-white rounded-circle mx-auto mb-2" style="width: 50px; height: 50px; line-height: 50px;">
                                    <i data-feather="cpu" width="20" height="20"></i>
                                </div>
                                <small>تحليل التقنيات</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step" id="step-3">
                                <div class="step-icon bg-secondary text-white rounded-circle mx-auto mb-2" style="width: 50px; height: 50px; line-height: 50px;">
                                    <i data-feather="search" width="20" height="20"></i>
                                </div>
                                <small>استخراج المحتوى</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="step" id="step-4">
                                <div class="step-icon bg-secondary text-white rounded-circle mx-auto mb-2" style="width: 50px; height: 50px; line-height: 50px;">
                                    <i data-feather="file-text" width="20" height="20"></i>
                                </div>
                                <small>إنشاء التقرير</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Status -->
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">
                        <i data-feather="info" class="me-2"></i>
                        الحالة الحالية
                    </h5>
                    <div id="current-status" class="text-muted">
                        بدء التحليل...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-icon {
    transition: all 0.3s ease;
}
.step-icon.active {
    background-color: #28a745 !important;
    transform: scale(1.1);
}
.step-icon.completed {
    background-color: #17a2b8 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resultId = {{ result.id | tojson }};
    let currentStep = 1;
    let progress = 0;
    
    // Initialize icons
    feather.replace();
    
    function updateProgress(step, message) {
        currentStep = step;
        progress = (step / 4) * 100;
        
        // Update progress bar
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        // Update status
        document.getElementById('current-status').textContent = message;
        
        // Update step icons
        for (let i = 1; i <= 4; i++) {
            const stepIcon = document.querySelector(`#step-${i} .step-icon`);
            stepIcon.classList.remove('active', 'completed');
            
            if (i < step) {
                stepIcon.classList.add('completed');
            } else if (i === step) {
                stepIcon.classList.add('active');
            }
        }
    }
    
    function checkStatus() {
        fetch(`/api/status/${resultId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    updateProgress(4, 'تم الانتهاء من التحليل! يتم تحويلك للنتائج...');
                    setTimeout(() => {
                        window.location.href = `/results/${resultId}`;
                    }, 2000);
                } else if (data.status === 'failed') {
                    document.getElementById('status-text').textContent = 'فشل في التحليل';
                    document.getElementById('current-status').textContent = data.error_message || 'حدث خطأ أثناء التحليل';
                } else {
                    // Simulate progress
                    if (currentStep < 3) {
                        currentStep++;
                        const messages = [
                            'جاري جمع بيانات الموقع...',
                            'تحليل التقنيات المستخدمة...',
                            'استخراج المحتوى والأصول...',
                            'إنشاء التقرير النهائي...'
                        ];
                        updateProgress(currentStep, messages[currentStep - 1]);
                    }
                }
            })
            .catch(error => {
                console.error('خطأ في التحديث:', error);
            });
    }
    
    // Start with first step
    updateProgress(1, 'بدء جمع بيانات الموقع...');
    
    // Check status every 2 seconds
    const statusCheck = setInterval(checkStatus, 2000);
    
    // Stop checking after 2 minutes
    setTimeout(() => {
        clearInterval(statusCheck);
    }, 120000);
});
</script>
{% endblock %}