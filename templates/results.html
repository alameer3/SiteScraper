{% extends 'base.html' %}

{% block title %}نتائج التحليل{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i data-feather="bar-chart-2" class="me-2"></i>
                    نتائج التحليل
                </h1>
                <div>
                    <a href="/history" class="btn btn-outline-secondary me-2">
                        <i data-feather="list" class="me-1"></i>
                        جميع التحليلات
                    </a>
                    <a href="/" class="btn btn-primary">
                        <i data-feather="plus" class="me-1"></i>
                        تحليل جديد
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if result %}
    <div class="row">
        <!-- معلومات أساسية -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="info" class="me-2"></i>
                        معلومات التحليل
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>الموقع:</strong> 
                                <a href="{{ result.url }}" target="_blank" class="text-decoration-none">
                                    {{ result.url }}
                                    <i data-feather="external-link" width="14" height="14"></i>
                                </a>
                            </p>
                            <p><strong>الحالة:</strong> 
                                {% if result.status == 'completed' %}
                                    <span class="badge bg-success">مكتمل</span>
                                {% elif result.status == 'failed' %}
                                    <span class="badge bg-danger">فشل</span>
                                {% else %}
                                    <span class="badge bg-warning">جاري المعالجة</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>تاريخ التحليل:</strong> {{ result.created_at.strftime('%Y-%m-%d %H:%M:%S') if result.created_at else 'غير محدد' }}</p>
                            <p><strong>نوع التحليل:</strong> {{ result.analysis_type or 'عام' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- بيانات الهيكل -->
        {% if result.structure_data %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="layout" class="me-2"></i>
                        تحليل الهيكل
                    </h5>
                </div>
                <div class="card-body">
                    {% set structure = result.get_structure_data() %}
                    {% if structure %}
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-primary mb-1">{{ structure.headings or 0 }}</h4>
                                    <small class="text-muted">العناوين</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-success mb-1">{{ structure.images or 0 }}</h4>
                                    <small class="text-muted">الصور</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-info mb-1">{{ structure.links or 0 }}</h4>
                                    <small class="text-muted">الروابط</small>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="border rounded p-3">
                                    <h4 class="text-warning mb-1">{{ structure.forms or 0 }}</h4>
                                    <small class="text-muted">النماذج</small>
                                </div>
                            </div>
                        </div>
                        {% if structure.title %}
                            <hr>
                            <p><strong>عنوان الصفحة:</strong><br>
                               <span class="text-muted">{{ structure.title }}</span></p>
                        {% endif %}
                        {% if structure.meta_description %}
                            <p><strong>الوصف:</strong><br>
                               <span class="text-muted">{{ structure.meta_description }}</span></p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">لا توجد بيانات هيكل متاحة</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- بيانات SEO -->
        {% if result.seo_data %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="trending-up" class="me-2"></i>
                        تحليل SEO
                    </h5>
                </div>
                <div class="card-body">
                    {% set seo = result.get_seo_data() %}
                    {% if seo %}
                        <div class="row">
                            {% if seo.analyzed %}
                                <div class="col-12 mb-3">
                                    <div class="alert alert-success">
                                        <i data-feather="check-circle" class="me-2"></i>
                                        تم تحليل SEO بنجاح
                                    </div>
                                </div>
                            {% endif %}
                            {% if seo.data %}
                                <div class="col-12">
                                    <h6>تفاصيل التحليل:</h6>
                                    <ul class="list-unstyled">
                                        {% for key, value in seo.data.items() %}
                                            <li class="mb-2">
                                                <strong>{{ key }}:</strong> {{ value }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-muted">لا توجد بيانات SEO متاحة</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- رسالة خطأ -->
        {% if result.error_message %}
        <div class="col-12 mb-4">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i data-feather="alert-circle" class="me-2"></i>
                        خطأ في التحليل
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-danger mb-0">{{ result.error_message }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- إجراءات إضافية -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="settings" class="me-2"></i>
                        إجراءات إضافية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-primary w-100" onclick="reanalyze()">
                                <i data-feather="refresh-cw" class="me-2"></i>
                                إعادة التحليل
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-success w-100" onclick="exportResults()">
                                <i data-feather="download" class="me-2"></i>
                                تصدير النتائج
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-info w-100" onclick="shareResults()">
                                <i data-feather="share-2" class="me-2"></i>
                                مشاركة النتائج
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i data-feather="alert-triangle" width="64" height="64" class="text-warning mb-3"></i>
                    <h4 class="text-muted">لم يتم العثور على نتائج</h4>
                    <p class="text-muted">النتائج المطلوبة غير متاحة أو تم حذفها</p>
                    <a href="/" class="btn btn-primary">
                        <i data-feather="home" class="me-2"></i>
                        العودة للرئيسية
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});

function reanalyze() {
    {% if result %}
    if (confirm('هل تريد إعادة تحليل هذا الموقع؟')) {
        window.location.href = '/?url=' + encodeURIComponent('{{ result.url }}');
    }
    {% endif %}
}

function exportResults() {
    alert('ميزة التصدير ستتوفر قريباً');
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'نتائج تحليل الموقع',
            text: 'شاهد نتائج تحليل الموقع',
            url: window.location.href
        });
    } else {
        // نسخ الرابط
        navigator.clipboard.writeText(window.location.href).then(function() {
            alert('تم نسخ الرابط إلى الحافظة');
        });
    }
}
</script>
{% endblock %}