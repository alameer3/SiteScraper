
{% extends "base.html" %}

{% block title %}تحليل الأمان المتقدم{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card bg-dark border-primary">
                <div class="card-header bg-primary">
                    <h4 class="mb-0">
                        <i data-feather="shield"></i>
                        تحليل الأمان المتقدم - {{ analysis.domain }}
                    </h4>
                </div>
                
                <div class="card-body">
                    <!-- نقاط الأمان العامة -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-secondary">
                                <div class="card-body text-center">
                                    <h2 class="text-{% if analysis.overall_score >= 80 %}success{% elif analysis.overall_score >= 60 %}warning{% else %}danger{% endif %}">
                                        {{ analysis.overall_score }}/100
                                    </h2>
                                    <p class="mb-0">نقاط الأمان</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary">
                                <div class="card-body text-center">
                                    <h4 class="text-{% if analysis.risk_level == 'منخفض' %}success{% elif analysis.risk_level == 'متوسط' %}warning{% else %}danger{% endif %}">
                                        {{ analysis.risk_level }}
                                    </h4>
                                    <p class="mb-0">مستوى المخاطر</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary">
                                <div class="card-body text-center">
                                    <h4 class="text-danger">
                                        {{ analysis.critical_vulnerabilities|length }}
                                    </h4>
                                    <p class="mb-0">ثغرات حرجة</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- التوصيات الحرجة -->
                    {% if analysis.recommendations %}
                    <div class="alert alert-warning mb-4">
                        <h5><i data-feather="alert-triangle"></i> التوصيات الأمنية</h5>
                        <ul class="mb-0">
                            {% for rec in analysis.recommendations[:5] %}
                            <li>{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- تبويبات التحليل المفصل -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#vulnerabilities">الثغرات الأمنية</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#injection">ثغرات الحقن</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#exposed-files">الملفات المكشوفة</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#info-leaks">تسريب المعلومات</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#admin-panels">لوحات الإدارة</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#ssl-analysis">تحليل SSL</a>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- تبويب الثغرات الأمنية -->
                        <div class="tab-pane fade show active" id="vulnerabilities">
                            <div class="row">
                                <!-- Directory Traversal -->
                                {% if analysis.directory_traversal_scan %}
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="folder"></i> Directory Traversal</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.directory_traversal_scan.vulnerable_parameters %}
                                                <div class="alert alert-danger">
                                                    <strong>تم اكتشاف ثغرة!</strong><br>
                                                    معاملات مُعرضة: {{ analysis.directory_traversal_scan.vulnerable_parameters|length }}
                                                </div>
                                                {% for vuln in analysis.directory_traversal_scan.vulnerable_parameters %}
                                                <div class="small text-warning mb-2">
                                                    معامل: {{ vuln.parameter }}<br>
                                                    Payload: {{ vuln.payload }}
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="alert alert-success">آمن</div>
                                            {% endif %}
                                            <small class="text-muted">
                                                تم اختبار {{ analysis.directory_traversal_scan.payloads_tested }} payload
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- XSS Vulnerabilities -->
                                {% if analysis.vulnerability_scan %}
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="code"></i> XSS Vulnerabilities</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.vulnerability_scan.xss_vulnerability.found %}
                                                <div class="alert alert-warning">
                                                    <strong>تم اكتشاف إشارات XSS!</strong>
                                                </div>
                                                {% for indicator in analysis.vulnerability_scan.xss_vulnerability.indicators %}
                                                <div class="small text-warning">{{ indicator }}</div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="alert alert-success">آمن</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- تبويب ثغرات الحقن -->
                        <div class="tab-pane fade" id="injection">
                            {% if analysis.injection_scan %}
                            <div class="row">
                                <!-- SQL Injection -->
                                <div class="col-md-4 mb-3">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="database"></i> SQL Injection</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.injection_scan.sql_injection.vulnerable %}
                                                <div class="alert alert-danger">
                                                    <strong>ثغرة خطيرة!</strong><br>
                                                    {{ analysis.injection_scan.sql_injection.details|length }} نقطة ضعف
                                                </div>
                                            {% else %}
                                                <div class="alert alert-success">آمن</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- XSS Injection -->
                                <div class="col-md-4 mb-3">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="code"></i> XSS Injection</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.injection_scan.xss_injection.vulnerable %}
                                                <div class="alert alert-warning">
                                                    <strong>ثغرة موجودة!</strong><br>
                                                    {{ analysis.injection_scan.xss_injection.details|length }} نقطة ضعف
                                                </div>
                                            {% else %}
                                                <div class="alert alert-success">آمن</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Command Injection -->
                                <div class="col-md-4 mb-3">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="terminal"></i> Command Injection</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.injection_scan.command_injection.vulnerable %}
                                                <div class="alert alert-danger">
                                                    <strong>ثغرة خطيرة جداً!</strong><br>
                                                    {{ analysis.injection_scan.command_injection.details|length }} نقطة ضعف
                                                </div>
                                            {% else %}
                                                <div class="alert alert-success">آمن</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب الملفات المكشوفة -->
                        <div class="tab-pane fade" id="exposed-files">
                            {% if analysis.exposed_files_scan %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i data-feather="file-text"></i> ملفات التكوين المكشوفة</h6>
                                    {% if analysis.exposed_files_scan.config_files %}
                                        <div class="alert alert-danger">
                                            تم العثور على {{ analysis.exposed_files_scan.config_files|length }} ملف تكوين مكشوف!
                                        </div>
                                        {% for file in analysis.exposed_files_scan.config_files %}
                                        <div class="card bg-danger mb-2">
                                            <div class="card-body py-2">
                                                <small>{{ file.url }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-success">لم يتم العثور على ملفات تكوين مكشوفة</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <h6><i data-feather="database"></i> ملفات قواعد البيانات</h6>
                                    {% if analysis.exposed_files_scan.database_files %}
                                        <div class="alert alert-danger">
                                            تم العثور على {{ analysis.exposed_files_scan.database_files|length }} ملف قاعدة بيانات مكشوف!
                                        </div>
                                        {% for file in analysis.exposed_files_scan.database_files %}
                                        <div class="card bg-danger mb-2">
                                            <div class="card-body py-2">
                                                <small>{{ file.url }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-success">لم يتم العثور على ملفات قواعد بيانات مكشوفة</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب تسريب المعلومات -->
                        <div class="tab-pane fade" id="info-leaks">
                            {% if analysis.information_leak_scan %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i data-feather="key"></i> مفاتيح API مكشوفة</h6>
                                    {% if analysis.information_leak_scan.api_keys %}
                                        <div class="alert alert-danger">
                                            تم العثور على {{ analysis.information_leak_scan.api_keys|length }} مفتاح API مكشوف!
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">لم يتم العثور على مفاتيح API مكشوفة</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <h6><i data-feather="mail"></i> عناوين البريد الإلكتروني</h6>
                                    {% if analysis.information_leak_scan.email_addresses %}
                                        <div class="alert alert-warning">
                                            تم العثور على {{ analysis.information_leak_scan.email_addresses|length }} عنوان بريد إلكتروني
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">لا توجد عناوين بريد إلكتروني مكشوفة</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i data-feather="alert-circle"></i> أخطاء قواعد البيانات</h6>
                                    {% if analysis.information_leak_scan.database_errors %}
                                        <div class="alert alert-warning">
                                            تم العثور على {{ analysis.information_leak_scan.database_errors|length }} خطأ قاعدة بيانات
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">لا توجد أخطاء قواعد بيانات مكشوفة</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <h6><i data-feather="info"></i> معلومات التصحيح</h6>
                                    {% if analysis.information_leak_scan.debug_info %}
                                        <div class="alert alert-warning">
                                            تم العثور على {{ analysis.information_leak_scan.debug_info|length }} معلومة تصحيح
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success">لا توجد معلومات تصحيح مكشوفة</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب لوحات الإدارة -->
                        <div class="tab-pane fade" id="admin-panels">
                            {% if analysis.admin_panel_detection %}
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i data-feather="shield"></i> لوحات الإدارة المكتشفة</h6>
                                    {% if analysis.admin_panel_detection.found_panels %}
                                        <div class="alert alert-warning">
                                            تم العثور على {{ analysis.admin_panel_detection.found_panels|length }} لوحة إدارة
                                        </div>
                                        {% for panel in analysis.admin_panel_detection.found_panels %}
                                        <div class="card bg-warning mb-2">
                                            <div class="card-body py-2">
                                                <small>{{ panel.url }}</small><br>
                                                <small class="text-muted">{{ panel.title }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-success">لم يتم العثور على لوحات إدارة مكشوفة</div>
                                    {% endif %}
                                </div>

                                <div class="col-md-6">
                                    <h6><i data-feather="log-in"></i> صفحات تسجيل الدخول</h6>
                                    {% if analysis.admin_panel_detection.login_pages %}
                                        <div class="alert alert-info">
                                            تم العثور على {{ analysis.admin_panel_detection.login_pages|length }} صفحة تسجيل دخول
                                        </div>
                                        {% for page in analysis.admin_panel_detection.login_pages %}
                                        <div class="card bg-info mb-2">
                                            <div class="card-body py-2">
                                                <small>{{ page.url }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-success">لم يتم العثور على صفحات تسجيل دخول واضحة</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب تحليل SSL -->
                        <div class="tab-pane fade" id="ssl-analysis">
                            {% if analysis.ssl_analysis %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="lock"></i> حالة SSL</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.ssl_analysis.has_ssl %}
                                                <div class="alert alert-success">
                                                    <i data-feather="check-circle"></i> SSL مُفعل
                                                </div>
                                                <p><strong>إصدار البروتوكول:</strong> {{ analysis.ssl_analysis.protocol_version }}</p>
                                                <p><strong>مُصدر الشهادة:</strong> {{ analysis.ssl_analysis.certificate_issuer }}</p>
                                                <p><strong>تاريخ الانتهاء:</strong> {{ analysis.ssl_analysis.expiry_date }}</p>
                                            {% else %}
                                                <div class="alert alert-danger">
                                                    <i data-feather="x-circle"></i> SSL غير مُفعل
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="card bg-secondary">
                                        <div class="card-header">
                                            <h6><i data-feather="shield"></i> رؤوس الأمان</h6>
                                        </div>
                                        <div class="card-body">
                                            {% if analysis.headers_analysis %}
                                                <p><strong>الرؤوس الموجودة:</strong> {{ analysis.headers_analysis.present_headers|length }}</p>
                                                <p><strong>الرؤوس المفقودة:</strong> {{ analysis.headers_analysis.missing_headers|length }}</p>
                                                <p><strong>نقاط الرؤوس:</strong> {{ analysis.headers_analysis.total_score }}</p>
                                                
                                                {% if analysis.headers_analysis.missing_headers %}
                                                <div class="mt-2">
                                                    <small class="text-warning">رؤوس مفقودة:</small>
                                                    {% for header in analysis.headers_analysis.missing_headers %}
                                                    <br><small class="text-muted">- {{ header }}</small>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- إجراءات إضافية -->
                    <div class="mt-4">
                        <div class="card bg-secondary">
                            <div class="card-header">
                                <h6><i data-feather="download"></i> تصدير التقرير</h6>
                            </div>
                            <div class="card-body">
                                <p>يمكنك تصدير تقرير الأمان كاملاً لمراجعته أو مشاركته مع فريقك.</p>
                                <a href="{{ url_for('export_security_report', url=analysis.url) }}" class="btn btn-primary">
                                    <i data-feather="download"></i> تصدير كـ JSON
                                </a>
                                <a href="{{ url_for('generate_security_pdf', url=analysis.url) }}" class="btn btn-secondary ms-2">
                                    <i data-feather="file-text"></i> تصدير كـ PDF
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// تفعيل الأيقونات
feather.replace();

// إضافة تأثيرات بصرية للتبويبات
document.addEventListener('DOMContentLoaded', function() {
    const tabLinks = document.querySelectorAll('.nav-link');
    tabLinks.forEach(link => {
        link.addEventListener('click', function() {
            // إضافة تأثير تحميل للتبويب
            const target = this.getAttribute('href');
            const tabContent = document.querySelector(target);
            if (tabContent) {
                tabContent.style.opacity = '0.5';
                setTimeout(() => {
                    tabContent.style.opacity = '1';
                }, 200);
            }
        });
    });
});
</script>

{% endblock %}
