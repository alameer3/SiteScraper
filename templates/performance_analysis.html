{% extends "base.html" %}

{% block title %}تحليل الأداء - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-success text-white">
                    <h2 class="mb-0">
                        <i data-feather="zap" class="me-2"></i>
                        تحليل الأداء المتقدم
                    </h2>
                </div>
                <div class="card-body p-4">
                    <form id="performanceForm">
                        <div class="mb-4">
                            <label for="url" class="form-label fw-bold">رابط الموقع</label>
                            <input type="url" class="form-control form-control-lg" id="url" 
                                   placeholder="https://example.com" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">أنواع تحليل الأداء</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="speed" value="speed" checked>
                                        <label class="form-check-label" for="speed">
                                            سرعة التحميل
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="optimization" value="optimization" checked>
                                        <label class="form-check-label" for="optimization">
                                            فرص التحسين
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="caching" value="caching" checked>
                                        <label class="form-check-label" for="caching">
                                            التخزين المؤقت
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="resources" value="resources" checked>
                                        <label class="form-check-label" for="resources">
                                            تحليل الموارد
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-lg">
                            <i data-feather="activity" class="me-2"></i>
                            بدء تحليل الأداء
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Progress Section -->
            <div id="progress-section" class="card shadow-lg border-0 mb-4" style="display: none;">
                <div class="card-body">
                    <div class="text-center">
                        <div class="spinner-border text-success mb-3" role="status">
                            <span class="visually-hidden">جاري التحليل...</span>
                        </div>
                        <h5>جاري تحليل أداء الموقع...</h5>
                        <p class="text-muted">قد تستغرق هذه العملية بضع دقائق</p>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
    
    document.getElementById('performanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const url = document.getElementById('url').value;
        const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const analysisTypes = Array.from(checkboxes).map(cb => cb.value);
        
        if (!url) {
            alert('يرجى إدخال رابط الموقع');
            return;
        }
        
        // Show progress
        document.getElementById('progress-section').style.display = 'block';
        document.getElementById('results-section').style.display = 'none';
        
        // Send analysis request
        fetch('/api/performance-analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: url,
                analysis_types: analysisTypes
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('progress-section').style.display = 'none';
            displayResults(data);
        })
        .catch(error => {
            document.getElementById('progress-section').style.display = 'none';
            alert('حدث خطأ أثناء التحليل: ' + error.message);
        });
    });
    
    function displayResults(data) {
        const resultsSection = document.getElementById('results-section');
        resultsSection.innerHTML = `
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">
                        <i data-feather="bar-chart-2" class="me-2"></i>
                        نتائج تحليل الأداء
                    </h3>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded">${JSON.stringify(data, null, 2)}</pre>
                </div>
            </div>
        `;
        resultsSection.style.display = 'block';
        feather.replace();
    }
});
</script>
{% endblock %}